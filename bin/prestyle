#!/usr/bin/env node

'use strict'; //eslint-disable-line

const fs = require('fs');
const path = require('path');
const program = require('commander');
const chalk = require('chalk');
const union = require('lodash/union');
const flattenDeep = require('lodash/flattenDeep');
const packageJSON = require('../package.json');
const PreStyle = require('../src/js/prestyle');

program
  .version(packageJSON.version)
  .option('-c, --config [file]', 'source config file')
  .option('-o, --outputFile [file]', 'generated .css file')
  .option('-p, --prependedFiles <items>', 'comma separated list of files to prepend', list => list.split(','))
  .parse(process.argv);

function preStyleFile(file, config) {
  console.log(`Processing file ${chalk.cyan(file)}`);
  const fileContents = fs.readFileSync(file, { encoding: 'utf-8' });

  //Initially, look for PreStyle`...` blocks
  const blocks = [];
  const re = /PreStyle`\s([\s\S]+?)\s`/gm;
  let matches;

  while ((matches = re.exec(fileContents)) !== null) blocks.push(matches[1]);

  return blocks.map(block => PreStyle(block, config));
}

function processFiles(config) {
  return config.sourceFiles.map(function processFile(file) {
    const resloc = path.relative(process.cwd(), path.resolve(file));
    const stat = fs.statSync(resloc);

    if (stat.isFile()) {
      return preStyleFile(resloc, config);
    } else if (stat.isDirectory()) {
      console.log(`Looking for files in directory ${chalk.cyan(resloc)}`);
      return fs.readdirSync(resloc).map(fn => processFile(`${resloc}/${fn}`));
    }

    return null;
  });
}

try {
  //Get config info
  const configFileLocation = program.config || 'PreStyleConfig.js';

  if (!fs.existsSync(path.resolve(configFileLocation))) {
    throw new Error(`Configuration file “${chalk.cyan(configFileLocation)}” not found.`);
  }

  const config = Object.assign(
    {},
    require(path.resolve('src/js/config')),
    require(path.resolve(configFileLocation)),
    (program.outputFile ? { outputFile: program.outputFile } : {}),
    (program.prependedFiles ? { prependedFiles: program.prependedFiles } : {})
  );

  if (!config.outputFile) {
    throw new Error(`You ${chalk.bold('MUST')} specify an output file with ${chalk.italic('-o')}, ${chalk.italic('--outputFile')}, or via the config file.`);
  }

  if (!config.adapter) {
    throw new Error(`You ${chalk.bold('MUST')} specify an adapter in the config file or leave it undefined to use the default.`);
  }

  config.sourceFiles = union(program.args) || [];

  //Write!
  const promises = flattenDeep(processFiles(config));
  Promise.all(promises)
    .then(
      (data) => {
        fs.mkdir(path.dirname(config.outputFile), () => {
          const cssContent = data.map(cssObj => cssObj.css).join('');
          const classnameContent = JSON.stringify(union(flattenDeep(data.map(cssObj => cssObj.classNames.split(' ')))));

          fs.writeFile(path.resolve(config.outputFile), cssContent, (err) => {
            if (err) throw err;

            console.log(`${chalk.green('File')} ${chalk.cyan(path.basename(config.outputFile))} ${chalk.green('created.')}`);
          });

          fs.writeFile(path.resolve(`${config.outputFile}.classNames.json`), classnameContent, (err) => {
            if (err) throw err;

            console.log(`${chalk.green('File')} ${chalk.cyan(path.basename(`${config.outputFile}.classNames.json`))} ${chalk.green('created.')}`);
          });
        });
      }
    )
    .catch((e) => {
      console.log(chalk.underline.red('PreStyle ran into errors processing your files:'));
      console.log(e);
    });
} catch (e) {
  console.log(chalk.underline.red('Error:'));
  console.log(e);
}
