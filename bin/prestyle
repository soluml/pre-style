#!/usr/bin/env node

'use strict'; //eslint-disable-line

/* eslint no-console: 0, global-require: 0, no-cond-assign: 0, import/no-dynamic-require: 0 */

const fs = require('fs');
const path = require('path');
const program = require('commander');
const chalk = require('chalk');
const union = require('lodash/union');
const flattenDeep = require('lodash/flattenDeep');

const packageJSON = require('../package.json');
const Normalize = require('../src/js/normalize');
const preStyleFile = require('./processFile');

program
  .version(packageJSON.version)
  .option('-c, --config [file]', 'source config file')
  .option('-o, --outputFile [file]', 'generated .css file')
  .option('-d, --destination <dir>', 'directory to put files processed by PreStyle')
  .option('-p, --prependedFiles <items>', 'comma separated list of files to prepend', list => list.split(','))
  .parse(process.argv);

function processFiles(config) {
  return config.sourceFiles.map(function processFile(file) {
    const resloc = path.relative(process.cwd(), path.resolve(file));
    const stat = fs.statSync(resloc);

    if (stat.isFile()) {
      return preStyleFile(resloc, config);
    } else if (stat.isDirectory()) {
      console.log(`Looking for files in directory ${chalk.cyan(resloc)}`);
      return fs.readdirSync(resloc).map(fn => processFile(`${resloc}/${fn}`));
    }

    return null;
  });
}

let config;

try {
  //Get config info
  const configFileLocation = program.config || 'PreStyleConfig.js';

  if (!fs.existsSync(path.resolve(configFileLocation))) {
    throw new Error(`Configuration file “${chalk.cyan(configFileLocation)}” not found.`);
  }

  config = Object.assign(
    {},
    require(path.resolve('src/js/config')),
    require(path.resolve(configFileLocation)),
    (program.destination ? { destination: program.destination || './' } : {}),
    (program.outputFile ? { outputFile: program.outputFile } : {}),
    (program.prependedFiles ? { prependedFiles: program.prependedFiles } : {})
  );

  if (!config.destination) {
    throw new Error(`You ${chalk.bold('MUST')} specify a destination with ${chalk.italic('-d')}, ${chalk.italic('--destination')}, or via the config file.`);
  }

  if (!config.outputFile) {
    throw new Error(`You ${chalk.bold('MUST')} specify an output file with ${chalk.italic('-o')}, ${chalk.italic('--outputFile')}, or via the config file.`);
  }

  if (!config.adapter) {
    throw new Error(`You ${chalk.bold('MUST')} specify an adapter in the config file or leave it undefined to use the default.`);
  }

  config.sourceFiles = union(program.args) || [];

  //Write!
  Promise.all(flattenDeep(processFiles(config)))
    .then(
      (data) => {
        fs.mkdir(path.resolve(config.destination), () => {
          const cssContent = Normalize(data.map(cssObj => cssObj.css).join(''));
          const classnameContent = JSON.stringify(union(flattenDeep(data.map(cssObj => cssObj.classNames.split(' ')))));

          cssContent.then((cssObj) => {
            data.forEach((processedFile) => {
              const filePath = path.resolve(config.destination, processedFile.path);

              fs.mkdir(path.dirname(filePath), () => {
                fs.writeFile(filePath, processedFile.contents, (err) => {
                  if (err) throw err;

                  console.log(`${chalk.green('File')} ${chalk.cyan(processedFile.path)} ${chalk.green('created.')}`);
                });
              });
            });

            fs.writeFile(path.resolve(config.destination, config.outputFile), cssObj[0].css, (err) => {
              if (err) throw err;

              console.log(`${chalk.green('File')} ${chalk.cyan(path.basename(config.outputFile))} ${chalk.green('created.')}`);
            });

            fs.writeFile(path.resolve(config.destination, `${config.outputFile}.classNames.json`), classnameContent, (err) => {
              if (err) throw err;

              console.log(`${chalk.green('File')} ${chalk.cyan(path.basename(`${config.outputFile}.classNames.json`))} ${chalk.green('created.')}`);
            });
          });
        });
      }
    )
    .catch((e) => {
      console.log(chalk.underline.red('PreStyle ran into errors processing your files:'));
      console.log(e);
    });
} catch (e) {
  console.log(chalk.underline.red('Error:'));
  console.log(e);
}
